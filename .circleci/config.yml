version: 2.1

jobs:
  build:
    docker:
      - image: rust:latest
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - run: cargo --version
      - run: cargo login $CARGO_REGISTRY_TOKEN
      - run:
          name: Run Tests
          command: "cargo test --all --all-features --color always -v"
  publisher:
    docker:
      - image: rust:latest
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - run:
          name: Publish crate features
          command: |
            cargo publish --all-features --jobs 1 -v --token $CARGO_REGISTRY_TOKEN -p scsys-core
            cargo publish --all-features --jobs 1 -v --token $CARGO_REGISTRY_TOKEN -p scsys-crypto
            cargo publish --all-features --jobs 1 -v --token $CARGO_REGISTRY_TOKEN -p scsys-derive
            cargo publish --all-features --jobs 1 -v --token $CARGO_REGISTRY_TOKEN -p scsys-gen
            cargo publish --all-features --jobs 1 -v --token $CARGO_REGISTRY_TOKEN -p scsys-macros
      - run:
          name: Publish (crate)
          command: cargo publish --all-features --jobs 1 --verbose -p scsys

workflows:
  rust:
    jobs:
      - build:
          filters:
            branches:
              only: main
      - publisher:
          requires: [build]
          filters:
            branches:
              only: main # only deploy when on main